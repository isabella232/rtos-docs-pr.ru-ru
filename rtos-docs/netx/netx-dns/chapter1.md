---
title: Глава 1. Введение в DNS-клиент для ОСРВ Azure NetX
description: DNS для ОСРВ Azure NetX предоставляет распределенную базу данных, которая содержит сведения о сопоставлении между доменными именами и физическими IP-адресами.
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: fda8c5b1bdb35e8312204374592e411a6a1e44f79a4a75a035a7886223c22b53
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116796397"
---
# <a name="chapter-1---introduction-to-the-azure-rtos-netx-dns-client"></a>Глава 1. Введение в DNS-клиент для ОСРВ Azure NetX

DNS для ОСРВ Azure NetX предоставляет распределенную базу данных, которая содержит сведения о сопоставлении между доменными именами и физическими IP-адресами. База данных называется *распределенной*, так как в Интернете нет единой сущности, содержащей полные сведения о сопоставлении. Сущность, которая обслуживает часть сведений о сопоставлении, называется DNS-сервером. Интернет состоит из многочисленных DNS-серверов, каждый из которых содержит подмножество указанной базы данных. DNS-серверы также отвечают на запросы DNS-клиентов на предоставление сведений о сопоставлении доменных имен, только если соответствующий сервер содержит запрошенное сопоставление.

Протокол DNS-клиента для NetX предоставляет приложению службы для запроса сведений о сопоставлении с одного или нескольких DNS-серверов.

## <a name="dns-client-setup"></a>Установка DNS-клиента

Для правильной работы пакету DNS-клиента требуется, чтобы экземпляр IP-адреса в NetX уже был создан.

После создания DNS-клиента приложение должно добавить один или несколько DNS-серверов в список серверов, обслуживаемый DNS-клиентом. Для добавления DNS-серверов приложение использует службу *nx_dns_server_add*.

Если параметр NX_DNS_IP_GATEWAY_SERVER включен, а адрес шлюза экземпляра IP-адреса не равен нулю, то шлюз экземпляра IP-адреса автоматически добавляется в качестве основного DNS-сервера. Если сведения о DNS-сервере не заданы статически, их также можно получить с помощью протокола DHCP для NetX. Дополнительные сведения см. в руководстве пользователя по DHCP для NetX.

DNS-клиенту нужен пул пакетов для передачи сообщений DNS. По умолчанию DNS-клиент создает этот пул пакетов при вызове службы *nx_dns_create*. Параметры конфигурации NX_DNS_PACKET_PAYLOAD и NX_DNS_PACKET_POOL_SIZE позволяют приложению определить полезные данные пакета и размер (то есть число пакетов) этого пула пакетов соответственно. Эти параметры описаны в разделе "Параметры конфигурации" главы 2.

Альтернативой клиенту DNS, создающему свой пул пакетов, является создание приложением пула пакетов и его назначение в качестве пула пакетов клиента DNS с помощью службы *nx_dns_packet_pool_set*. Для этого необходимо определить параметр NX_DNS_CLIENT_USER_CREATE_PACKET_POOL. Этот параметр также требует ранее созданный с помощью *nx_packet_pool_create* пул пакетов, используемый в качестве входных данных указателя пула пакетов для *nx_dns_packet_pool_set*. При удалении экземпляра DNS-клиента приложение отвечает за удаление пула пакетов клиента DNS, если он больше не требуется, когда включен параметр NX_DNS_CLIENT_USER_CREATE_PACKET_POOL.

>[!NOTE] 
> Для приложений, которые предоставляют собственный пул пакетов с помощью **параметра NX_DNS_CLIENT_USER_CREATE_PACKET_POOL,** размер пакета должен вмещать в себя сообщение DNS максимального размера (512 байт), а также заголовок UDP, заголовок IPv4 и заголовок MAC.

## <a name="dns-messages"></a>Сообщения DNS

DNS имеет очень простой механизм получения сопоставления между именами узлов и IP-адресами. Чтобы получить сопоставление, клиент DNS подготавливает сообщение запроса DNS, содержащее имя или IP-адрес, которые необходимо разрешить. Затем сообщение отправляется на первый DNS-сервер в списке серверов. Если сервер содержит такое сопоставление, он отвечает клиенту DNS, используя ответное сообщение DNS, содержащее запрошенные сведения о сопоставлении. Если сервер не отвечает, клиент DNS отправляет запрос следующему серверу в списке, пока не будут запрошены все DNS-серверы. Если не получен ответ ни от одного из DNS-серверов, клиент DNS использует логику повторных попыток для повторной передачи сообщения DNS. При повторной отправке запроса DNS время ожидания повторной передачи удваивается. Этот процесс продолжает до тех пор, пока не будет достигнуто максимальное время ожидания передачи (определенное NX_DNS_MAX_RETRANS_TIMEOUT в *nxd_dns.h*) или пока не будет получен успешный ответ от такого сервера.

DNS-клиент для NetX может выполнять поиск IPv4-адресов (типа A) путем вызова *nx_dns_host_by_name_get* или *nx_dns_ipv4_address_by_name_get*. DNS-клиент может выполнять обратный просмотр IP-адресов (запросы типа PTR) для получения имен веб-узлов с помощью *nx_dns_host_by_address_get*.

Служба обмена сообщениями DNS использует протокол UDP для отправки запросов и ответов полей. DNS-сервер прослушивает номер порта 53 на предмет запросов от клиентов. Поэтому в NetX с помощью службы ***nx_udp_enable** _ должны быть включены службы UDP для ранее созданного экземпляра IP-адреса (_*_nx_ip_create_**).

На этом этапе DNS-клиент готов принимать запросы от приложения и отправлять запросы DNS.

## <a name="extended-dns-resource-record-types"></a>Расширенные типы записей ресурсов DNS

Если NX_DNS_ENABLE_EXTENDED_RR_TYPES включен, DNS-клиент для NetX также поддерживает запросы следующих типов записей:

- **CNAME**: содержит каноническое имя для псевдонима.

- **TXT**: содержит текстовую строку.

- **NS**: содержит полномочный сервер доменных имен.

- **SOA**: содержит начало зоны.

- **MX**: используется для обмена электронной почтой.

- **SRV**: содержит сведения о службе, предоставляемой доменом.

За исключением типов записей CNAME и TXT, приложение должно предоставить 4-байтовый выровненный буфер с получения записи данных DNS.

В DNS-клиенте для NetX данные записи хранятся таким образом, чтобы наиболее эффективно использовать место в буфере.

Для тех запросов, типы записей которых имеют переменную длину данных, как, например, записи NS, у которых имена узлов имеют переменную длину, DNS-клиент для NetX сохраняет данные следующим образом. Буфер, заданный в запросе DNS-клиента, организован в виде области данных фиксированной длины и области неструктурированной памяти. Верхняя часть буфера памяти поделена на 4-байтовые выровненные элементы записи. Каждый элемент записи содержит IP-адрес и указатель на данные переменной длины для этого IP-адреса. Данные переменной длины для каждого IP-адреса хранятся в области неструктурированной памяти, начиная с конца буфера памяти. Данные переменной длины для каждого последующего элемента записи сохраняются в следующей области памяти, примыкающей к данным переменной длинны предыдущих элементов записи. Таким образом, данные переменной длины "нарастают" в сторону области структурированной памяти, содержащей элементы записи, до тех пор, пока не перестанет хватать памяти для сохранения очередного элемента записи и данных переменной длины.

Это показано на рисунке ниже:

![Схема для примера хранилища данных доменных имен DNS (NS)](media/image1.png)

Выше приведен пример хранилища данных доменных имен DNS (NS).

Запросы DNS-клиента для NetX, использующие формат хранения записей, возвращают число записей, сохраненных в буфере записи. Эта информация позволяет приложению извлекать записи NS из буфера записей.

Ниже приведен пример запроса клиента DNS, который сохраняет данные переменной длины DNS с помощью этого формата хранения записей.

```c
UINT     _nx_dns_domain_name_server_get(NX_DNS *dns_ptr, UCHAR  *host_name, 
                                        VOID *record_buffer, UINT buffer_size, 
                                        UINT *record_count, ULONG wait_option);
```

Дополнительные сведения см. в главе 3, "Описание служб клиента DNS".

## <a name="dns-cache"></a>Кэш DNS

Если NX_DNS_CACHE_ENABLE включен, DNS-клиент NetX поддерживает функцию кэша DNS. После создания DNS-клиента приложение может вызвать API *nx_dns_cache_initialize()* , чтобы задать специальный кэш DNS. Если включить функцию кэша DNS, клиент DNS выполнит поиск доступного ответа в кэше DNS перед началом отправки запроса DNS. При нахождении доступного ответа он возвращается напрямую приложению, в противном случае клиент DNS отправляет сообщение запроса на DNS-сервер и ждет ответа. Когда клиент DNS получает ответное сообщение и доступен свободный кэш, клиент DNS возвращает ответ приложению, а также добавляет этот ответ в качестве записи ресурса в кэш DNS.

Каждый ответ представляет собой структуру данных *NX_DNS_RR* (запись ресурса) в кэше. Строки (данные и имя записи ресурса) в записях имеют переменную длину, поэтому не хранятся в структуре NX_DNS_RR. Запись содержит указатели на фактическую область памяти, в которой хранятся строки. Таблица строк и записи используют кэш совместно. Записи хранятся в начале кэша и нарастают по направлению к его концу. Таблица строк начинается с конца кэша и нарастает в сторону его начала. Каждая строка в таблице строк имеет поле длины и поле счетчика. Если при добавлении строки в таблицу строк там уже присутствует такая же строка, значение счетчика увеличивается, а память для строки не выделяется. Кэш считается заполненным, если в него больше нельзя добавить записи ресурсов или новые строки.

## <a name="dns-client-limitations"></a>Ограничения клиента DNS

Клиент DNS поддерживает выполнение одного запросу DNS за раз. Потоки, пытающиеся выполнить другой запрос DNS, временно блокируются до завершения предыдущего запроса DNS.

DNS-клиент для NetX не использует данные из заслуживающих доверия ответов для пересылки дополнительных запросов DNS на другие DNS-серверы.

## <a name="dns-rfcs"></a>Документы RFC по DNS

DNS для NetX соответствует следующим документам RFC:

- RFC1034. Доменные имена — понятия и возможности
- RFC1035. ДОМЕННЫЕ ИМЕНА — РЕАЛИЗАЦИЯ И СПЕЦИФИКАЦИЯ
- RFC1480. Домен США
- RFC 2782. Запись ресурса DNS для указания расположения служб (DNS SRV)