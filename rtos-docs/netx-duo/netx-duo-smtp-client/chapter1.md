---
title: Глава 1. Введение в SMTP клиент NetX Duo для ОСРВ Azure
description: Протокол SMTP — это протокол передачи почтовых сообщений по сетям и Интернету.
author: philmea
ms.author: philmea
ms.date: 07/09/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: f58a0c235f5c2cd108ba97afe676ffa9b66e715c
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814583"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-smtp-client"></a>Глава 1. Введение в SMTP клиент NetX Duo для ОСРВ Azure

Протокол SMTP — это протокол передачи почтовых сообщений по сетям и Интернету. Для выполнения функции передачи содержимого используется надежные службы протокола TCP.

## <a name="netx-duo-smtp-client-requirements"></a>Требования для клиента SMTP NetX Duo

Для клиента SMTP NetX Duo необходимо создать экземпляр IP NetX Duo и пул пакетов NetX Duo. Клиент SMTP использует TCP-сокет для подключения к серверу SMTP на *хорошо известном порте 25.* Поэтому сначала необходимо включить протокол TCP, вызвав службу *nx_tcp_enable* на ранее созданном экземпляре IP.

Вызов создания клиента SMTP (nxd_smtp_client_create) требует ранее созданного пула пакетов для передачи команд SMTP на сервер, а также для отправки самого почтового сообщения. Полезные данные пакета зависят от ожидаемого размера содержимого почты и должны разрешать TCP, заголовок IP и заголовок MAC. (Обратите внимание, что заголовок IPv6 составляет 40 байт, а заголовок IPv4 — 20 байт.)

Если все почтовое сообщение не помещается в одном пакете, то клиент SMTP выделяет дополнительные пакеты, чтобы вместить остальную часть сообщения.

## <a name="netx-duo-smtp-client-constraints"></a>Ограничения клиента SMTP NetX Duo

Хотя протокол SMTP NetX Duo реализует стандарты RFC 2821 и 2554, существуют некоторые ограничения.

1. Клиент SMTP NetX Duo поддерживает только проверку подлинности LOGIN и PLAIN, но не дайджест-аутентификацию CRAM-MD5.
2. Сообщения клиента SMTP NetX Duo ограничены одним получателем на один почтовый элемент и только одним почтовым сообщением на одно TCP-соединение к TCP-серверу.
3. Параметры SMTP VRFY, SEND, SOML, EXPN, SAML, ETRN, TURN и SIZE не поддерживаются.
4. Клиент SMTP не является браузером почты ("пользовательским почтовым агентом"), который обычно используется для создания почтового сообщения. Он является только "агентом перемещения почты". Он предоставляет необходимую обработку текста почтового сообщения для передачи по протоколу SMTP в соответствие с RFC 2821. Он не проверяет содержимое на предмет правильного синтаксиса, например получателя и обратного пути. Нет ограничений на то, что находится в почтовом буфере, например данные MIME или незашифрованные текстовые сообщения. Формат почтового сообщения, указанный в RFC 2822, в отношении включения заголовков и текста сообщения находится за рамками API клиента SMTP.

## <a name="commands-supported-by-netx-duo-smtp-client"></a>Команды, поддерживаемые клиентом SMTP DuoNetX Duo

Клиент SMTP NetX Duo использует следующие команды во время почтового сеанса с сервером SMTP.

- **EHLO** — клиент хочет инициировать сеанс, включающий некоторые или все SMTP-службы расширения протокола, доступные на сервере SMTP. Это значение по умолчанию.
- **HELO** — клиент хочет инициировать сеанс, ограниченный базовыми службами SMTP.
- **MAIL** — клиент хочет, чтобы сервер получил почту клиента.
- **AUTH** — клиент хочет инициировать проверку подлинности на сервере.
- **RCPT** — клиент хочет отправить адрес почтового ящика другого узла, которому будет доставлено сообщение.
- **DATA** — клиент хочет инициировать отправку данных почтового сообщения на сервер.
- **QUIT** — клиент хочет завершить сеанс.

## <a name="getting-started"></a>Приступая к работе

Клиентское приложение SMTP создает экземпляр IP и включает для него TCP. Затем оно создает клиента SMTP, используя следующую службу:

```C
UINT nxd_smtp_client_create(NX_SMTP_CLIENT *client_ptr,
    NX_IP *ip_ptr, NX_PACKET_POOL
    *client_packet_pool_ptr,
    CHAR *username, CHAR *password,
    CHAR *from_address,
    CHAR *client_domain,
    UINT authentication_type,
    NXD_ADDRESS *server_address, UINT port);
```

Параметр *client_packet_pool_ptr* является указателем на ранее созданный пул пакетов, который клиент SMTP будет использовать для отправки сообщений на сервер SMTP.

Обратите внимание, что приложение должно предоставлять параметр *from_address* для локального устройства и IP-адрес сервера. Все адреса должны представлять собой полное доменное имя. Полное доменное имя содержит локальную часть и доменное имя, разделенные символом "@". Обратите внимание, что клиент SMTP не проверяет синтаксис адресов *from_address* и *recipient_address* в службе nx_smtp_mail_send ниже.

После создания клиента SMTP клиентское приложение SMTP создает почтовый элемент с правильно отформатированным почтовым сообщением SMTP и отправляет запрос почтового элемента клиенту SMTP, используя следующий API:

```C
UINT nx_smtp_mail_send(NX_SMTP_CLIENT *client_ptr,
    CHAR *recipient_address, UINT priority,
    CHAR *subject, CHAR *mail_body,
    UINT mail_body_length);
```

С точки зрения пользователя нет никакой разницы в работе клиента SMTP по протоколу IPv4 или IPv6. Различия между двумя IP-протоколами обрабатываются на базовом уровне NetX Duo.

Обратите внимание, что приложение, желающее отправить почту, должно предоставить адрес получателя в вызове *nx_smtp_client_mail*.

Для проверки подлинности имена пользователей могут быть либо полными доменными именами, либо отображаемыми именами пользователей. Это зависит от того, как сервер выполняет проверку подлинности.

В разделе "Небольшой пример" ниже в этом руководство пользователя показано, как следует отформатировать сообщение. При успешной отправке почтового элемента состояние будет NX_SUCCESS. Если возникает ошибка, будь это внутренней ошибкой, разорванным TCP-соединением или получением кода ошибки ответа сервера, *nx_smtp_mail_send* возвращает состояние ошибки, отличное от нуля.

При отправке почтового элемента клиент SMTP NetX Duo создает новое TCP-соединение с сервером SMTP и начинает сеанс SMTP. В этом сеансе клиент отправляет ряд команд на сервер SMTP как часть протокола SMTP, заканчивая отправкой самого почтового сообщения. Подключение TCP завершается, независимо от результата сеанса SMTP.

После передачи почты, успешного или завершившегося сбоем, клиент SMTP возвращается в "начальное" состояние и может использоваться для другого сеанса передачи почты.

## <a name="netx-duo-smtp-authentication"></a>Проверка подлинности SMTP NetX Duo

Проверка подлинности — это способ, которым клиенты SMTP могут подтвердить свою личность на сервере SMTP и отправить почту в качестве доверенного пользователя. Для большинства коммерческих SMTP-серверов требуется проверка подлинности клиентов.

Как правило, данные проверки подлинности состоят из имени пользователя и пароля отправителя. Во время запроса проверки подлинности сервер запрашивает эти сведения, а клиент отвечает, отправляя запрошенные данные в закодированном формате. Сервер декодирует данные и пытается найти совпадение в пользовательской базе данных. Если совпадение найдено, сервер указывает, что проверка подлинности прошла успешно. Проверка подлинности SMTP определена в документе [RFC 2554](http://www.ietf.org/rfc/rfc2554.txt).

Различают две разновидности проверки подлинности: *обычную* и *с использованием дайджеста*. Дайджест не поддерживается в текущем клиенте SMTP NetX Duo и не рассматривается в этой статье. Обычная проверка подлинности эквивалентна проверке подлинности *имени* и *пароля*, описанной выше. При обычной проверке подлинности SMTP имя и пароль кодируются в кодировке base64. Преимущество обычной проверки подлинности заключается в простоте реализации и широком использовании. Основным недостатком обычной проверки подлинности является то, что имя и пароль передаются в запросе в незашифрованном виде.

### <a name="plain-authentication"></a>Проверка подлинности PLAIN

Клиент SMTP NetX Duo отправляет команду AUTH с параметром PLAIN. Если SMTP-сервер NetX Duo поддерживает такой тип проверки подлинности, он отправит код ответа 334. Клиент отвечает серверу одним сообщением с именем пользователя и паролем в кодировке base64. Если сервер определяет проверку подлинности клиента как успешную, он отвечает кодом успешного выполнения 235.

### <a name="login-authentication"></a>Проверка подлинности LOGIN

Клиент SMTP NetX Duo отправляет команду AUTH с параметром LOGIN. Если SMTP-сервер NetX Duo поддерживает такой тип проверки подлинности, он отправляет код ответа 334 в качестве начала "запроса" проверки подлинности. Он отправляет клиенту запрос в кодировке base64, которым обычно является "имя пользователя". Клиент декодирует запрос и отправляет ответ с именем пользователя в кодировке base64. Если сервер принимает имя пользователя клиента, он отправляет запрос на ввод пароля клиента в кодировке base64. Клиент отправляет в ответ пароль в кодировке base64. Если сервер определяет проверку подлинности клиента как успешную, он отвечает кодом успешного выполнения 235.

### <a name="no-authentication"></a>Без аутентификации

Некоторые серверы SMTP настроены без проверки подлинности. Если это так, то их ответ 250 на сообщение EHLO клиента не будет содержать типы проверки подлинности. Однако отсутствие перечисленных типов проверки подлинности не обязательно означает, что сервер не требует и не поддерживает проверку подлинности. Если в этой ситуации клиент настроен для аутентификации PLAIN или LOGIN, то задача потока клиента NetX Duo по умолчанию будет использовать PLAIN. Если клиент настроен для NONE, шаг проверки подлинности пропускается, а состояние SMTP переходит в состояние MAIL.

Обратите внимание, что если клиент настроен без проверки подлинности, а сервер SMTP поддерживает проверку подлинности, то тип проверки подлинности клиента переключается на PLAIN.

## <a name="rfcs-supported-by-netx-duo-smtp-client"></a>Документы RFC, поддерживаемые клиентом SMTP NetX Duo

API клиента SMTP NetX Duo соответствует стандарту RFC2821 "Протокол SMTP" и RFC 2554 "Расширение службы SMTP для проверки подлинности". “
