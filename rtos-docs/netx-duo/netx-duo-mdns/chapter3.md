---
title: Глава 3. Описание внутреннего кэша служб
description: 'Модуль mDNS в NetX Duo управляет двумя внутренними кэшами служб: локальным и одноранговым.'
author: philmea
ms.author: philmea
ms.date: 07/09/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 007f1080a076730cfbcdedc9f063ac0c427a414c
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814663"
---
# <a name="chapter-3---description-of-internal-service-cache"></a>Глава 3. Описание внутреннего кэша служб

Модуль mDNS в NetX Duo управляет двумя внутренними кэшами служб: локальным и одноранговым. В локальном кэше служб хранятся записи ресурсов, которые связаны со службами, предоставляемыми приложениями на узле. В случае с входящими запросами, если вопрос соответствует предлагаемой службе, mDNS выдает ответ, хранящийся в локальном кэше служб. Приложения регистрируют службы, вызывая интерфейс API *nx_mdns_service_add()* . Для удаления служб приложения используют интерфейс API *nx_mdns_service_delete()* , который, в свою очередь, рассылает сообщения о завершении перед удалением соответствующих записей из локального кэша службы.

При добавлении службы mDNS сохраняет по крайней мере три записи ресурсов в локальном кэше служб: SRV, PTR и TXT. Если тип службы включает подтип, может быть добавлена дополнительная запись ресурса PTR. Например, приложение регистрирует службу.

```
*name*._*subtype*._sub._*type*._tcp.local,
```

В локальный кэш служб добавляются две записи ресурсов PTR: одна для

```
“*_subtype._*sub*._type._*tcp.local *PTR name.type._*tcp*.*local”
```

и еще одна для

```
*“_type._*tcp*.*local *PTR name.type._*tcp*.*local”.
```

Одноранговый кэш служб содержит записи ресурсов mDNS, полученные от соседних узлов. Модуль mDNS собирает записи ресурсов, объявленные другими узлами в сети, и сохраняет полученные сведения в одноранговом кэше служб. Когда приложение запрашивает сведения, такие как IPv4- или IPv6-адреса узлов, mDNS ищет локально кэшированные ответы в одноранговом кэше служб. Когда приложение запрашивает службы, предлагаемые одноранговыми узлами, mDNS ищет в кэше связанные записи PTR, SRV, TXT, а также IPv4- и IPv6-адресов. В одноранговом кэше служб также хранятся запросы, отправленные узлу. Например, приложение может запросить определенную службу, вызвав *nx_mdns_service_one_shot_query*. Если служба не найдена в одноранговом кэше служб, mDNS создает вопросы запроса (PTR, SRV и TXT) в одноранговом кэше служб. Эти вопросы будут периодически отправляться в сеть, пока служба не будет разрешена или не истечет время ожидания. Аналогичным образом, приложение может использовать интерфейс API *nx_mdns_service_continous_query()* для запроса определенной службы в течение длительного периода времени (приложение отменяет ранее отправленный непрерывный запрос с помощью интерфейса API *nx_mdns_service_query_stop()* ). Чтобы найти определенную службу в одноранговом кэше служб, не отправляя запросы в сеть, приложения могут использовать интерфейс API *nx_mdns_serivce_lookup()* . Этот интерфейс API ищет записи ресурсов только в одноранговом кэше служб.

Каждая запись ресурса хранится в кэшах служб в структуре данных *NX_MDNS_RR*. Строки в записях ресурсов имеют переменную длину, поэтому не хранятся в структуре *NX_MDNS_RR*. Запись ресурса содержит указатель на фактическую область памяти, в которой хранится строка. Таблица строк и записи ресурсов совместно используют кэш служб. Записи ресурсов хранятся с начала кэша служб и нарастают по направлению к его концу. Таблица строк начинается с конца кэша служб и нарастает в сторону его начала. Каждая строка в таблице строк имеет поле длины и поле счетчика. Если при добавлении строки в таблицу строк там уже присутствует такая же строка, значение счетчика увеличивается, а память для строки не выделяется. Кэш служб считается заполненным, если в него больше нельзя добавить записи ресурсов или новые строки.

Приложение может найти службы, предлагаемые в локальной сети, двумя способами. Оно может либо произвести поиск определенной службы с помощью однократного запроса, либо инициировать непрерывный запрос для отслеживания действий в сети. В случае однократного запроса приложение должно указать тип службы. mDNS выполняет поиск в локальном и одноранговом кэшах служб. Если экземпляры службы найдены, однократный запрос возвращает сведения из записей ресурсов. Если в локальном или одноранговом кэше служб нет записей, mDNS отправляет сообщения запроса. Если указано имя экземпляра, то в локальную сеть отправляется тип *ANY* (запрос типа SRV и TXT) с определенным именем экземпляра в формате имя.тип.local. Если имя экземпляра не указано, в локальную сеть отправляется запрос типа PTR. Вызывающей стороне возвращается первая полученная служба.

Непрерывный запрос работает иначе. Типичный вариант использования непрерывного запроса — отслеживание определенной службы в локальной сети (например, постоянный поиск служб печати). В этом случае приложение выдает поисковый запрос (через интерфейс API *nx_mdns_service_continious_query*) для определенного типа служб. Вызывающая сторона обычно не ожидает определенного ответа. В случае с непрерывным запросом модуль mDNS периодически отправляет запросы через экспоненциально увеличивающиеся интервалы времени. Чтобы прерывать запрос, приложение должно с помощью интерфейса API *nx_mdns_service_query_stop* остановить его внутренний таймер. Тип запроса может иметь значение NULL. В этом случае задается специальный тип запроса PTR _services._dns-sd._udp.local. Он определяется в mDNS как способ обнаружения всех служб, доступных в локальной сети. Если указано имя экземпляра, то в локальную сеть отправляется тип ANY (запрос типов SRV и TXT) с определенным именем экземпляра в формате имя.тип.local. Если имя экземпляра имеет значение NULL, в локальную сеть отправляется запрос типа PTR.

Все ответы, в том числе на незатребованные запросы, записываются в одноранговый кэш служб. В дальнейшем приложение использует интерфейс API *nx_mdns_service_lookup* для получения определенной службы из однорангового кэша служб.

Особое замечание о фрагментации: каждая структура *NX_MDNS_RR* имеет фиксированный размер, поэтому не подвергается фрагментации, когда mDNS добавляет и удаляет записи ресурсов. Однако строки имеют переменную длину. После удаления строки пространство освобождается и может использоваться для новой строки, если она помещается. Однако эта операция приводит к фрагментации памяти. По мере добавления и удаления служб таблица строк может оказаться фрагментированной настолько, что новые строки больше невозможно добавить, хотя в кэше служб достаточно свободных байтов для строки. Локальные приложения, как правило, являются более стабильными и предсказуемыми. Поэтому локальный кэш служб меньше подвержен фрагментации. В случае же с одноранговым кэшем служб записи ресурсов постоянно добавляются, когда службы становятся доступны, или удаляются, когда службы удаляются узлами сети. Службы в сети появляются и исчезают, из-за чего в таблице строк чаще происходят операции выделения и удаления. Со временем таблица строк может оказаться фрагментированной. В такой ситуации проще всего очистить весь одноранговый кэш служб. Для этого можно вызвать интерфейс API *nx_mdns_peer_cache_clear()* . Обратите внимание, что этот интерфейс API автоматически завершает все текущие непрерывные запросы.
