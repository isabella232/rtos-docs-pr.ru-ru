---
title: Глава 1. Введение в SNTP для NetX Duo (ОСРВ Azure)
description: Протокол SNTP для NetX (ОСРВ Azure) используется для синхронизации часов через Интернет.
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: a284871d8da9b8d6d220e962de5d27483dafab201b68d64d5c794c1edab50153
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116798832"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-sntp"></a>Глава 1. Введение в SNTP для NetX Duo (ОСРВ Azure) 

Протокол SNTP для NetX (ОСРВ Azure) используется для синхронизации часов через Интернет. SNTP версии 4 — это упрощенный протокол на базе протокола NTP. Этот простой протокол без отслеживания состояния использует службы UDP для обновления сведений о времени. Хотя протокол SNTP не такой сложный, как NTP, он является точным и надежным. В большинстве расположений в современном Интернете SNTP обеспечивает точность от 1 до 50 миллисекунд в зависимости от характеристик источника синхронизации и сетевых путей. SNTP поддерживает много возможностей для обеспечения надежности получения обновлений времени. Возможность переключения на альтернативные серверы, применение алгоритмов опроса с задержкой и автоматическое обнаружение серверов времени — вот лишь некоторые из средств, которые клиент SNTP может применять в изменчивой среде службы времени в Интернете. Недостаток точности компенсируется простотой в применении и реализации. Протокол SNTP предназначен главным образом для предоставления полнофункциональных механизмов доступа к национальным службам времени и частоты (например, к серверу NTP).

## <a name="netx-duo-sntp-client-requirements"></a>Требования для клиента SNTP для NetX Duo

Для клиента SNTP NetX Duo требуется, чтобы заранее был создан экземпляр IP-адреса. Кроме того, в этом экземпляре IP-адреса должен быть включен протокол UDP и предоставлен доступ к *хорошо известному* порту 123 для отправки данных о времени на сервер SNTP. Впрочем, другие порты тоже подойдут. Широковещательным клиентам нужно привязать UDP-порт, на котором работает соответствующий широковещательный сервер, обычно это порт 123. Приложение клиента SNTP для NetX Duo должно использовать один или несколько IP-адресов сервера SNTP.

## <a name="netx-duo-sntp-client-limitations"></a>Ограничения для клиентов SNTP для NetX Duo 

Точность представления местного времени при обновлениях времени NTP через API клиента SNTP ограничена миллисекундами.

В любой момент времени клиент SNTP использует только один адрес сервера SNTP. Если этот сервер прекратит работу, приложение должно прервать задачу клиента SNTP и повторно инициализировать ее с другим адресом сервера SNTP, используя широковещательную или одноадресную связь SNTP.

Клиент SNTP не поддерживает многоадресную трансляцию.

Клиент SNTP для NetX Duo не поддерживает механизмы проверки подлинности для проверки полученных данных.

## <a name="netx-duo-sntp-client-operation"></a>Операции с клиентом SNTP для NetX Duo

Стандарт RFC 4330 рекомендует, чтобы клиенты SNTP работали только с самыми высоким уровнем (стратой) локальной сети и чтобы синхронизация клиентов NTP или SNTP не зависела от них. Страта обозначает позицию узла в иерархии времени NTP, где страта 1 является самым высоким уровнем (корневой сервер времени), а страта 15 — самым низким допустимым уровнем (клиент). По умолчанию клиент SNTP использует минимальное значение — страту 2.

Клиент SNTP для NetX Duo может работать для получения времени через Интернет в одном из двух основных режимов: одноадресная или широковещательная передача. В режиме одноадресной передачи клиент опрашивает сервер SNTP через равные промежутки времени и ожидает получения ответа от этого сервера. При получении ответа клиент проверяет, что в нем содержится допустимое обновление времени, применяя набор проверок в соответствии со стандартом RFC 4330. Затем клиент применяет разницу во времени, если она обнаружена, с часами сервера к своим локальным часам. В широковещательном режиме клиент просто ожидает широковещательные пакеты обновления времени и согласовывает с ними свои локальные часы после применения аналогичного набора проверок к данным об обновлении времени. Эти проверки подробно описаны в разделе **Проверки SNTP** ниже.

Прежде чем клиент сможет работать в любом режиме, он должен определить рабочие параметры. Для этого выполняется вызов *nx_sntp_client_initialize_unicast* или *nx_sntp_client_initialize_broadcast* для режимов широковещательной или одноадресной трансляции. Эти серверы задают максимально допустимый промежуток времени без допустимого обновления, ограничение на количество последовательно принятых недопустимых обновлений, интервал опроса в одноадресном режиме, режим работы (одноадресная и широковещательная трансляция) и сервер SNTP.

Если максимально допустимый промежуток времени или максимальное количество недопустимых обновлений превышаются, клиент SNTP продолжит работу, но установит для этого сервера SNTP состояние "Недопустимо". Приложение может опросить клиент SNTP через службу *nx_sntp_client_receiving_updates*, чтобы убедиться, что сервер SNTP по-прежнему отправляет допустимые обновления. Если это не так, он прерывает поток клиента SNTP с помощью службы *nx_sntp_client_stop* и вызывает любую из двух служб инициализации с другим адресом сервера SNTP. Чтобы перезапустить клиент SNTP, приложение вызывает *nx_sntp_client_run_broadcast* или *nx_sntp_client_run_unicast*. Обратите внимание, что приложение может изменить режим работы клиента SNTP при инициализации, чтобы выбрать одноадресную или широковещательную трансляцию.

### <a name="local-clock-operation"></a>Работа локальных часов

Время SNTP выражается в количестве секунд на главных часах NTP или в количестве секунд, прошедших в первой эпохе NTP, т. е. с **00:00:00 1 января 1900 года** по **00:00:00 1 января 1999 года**. Дата 01-01-1999 важна тем, что на нее пришлась последняя корректировочная секунда. Это значение определяется следующим образом:

\#define NTP_SECONDS_AT_01011999 0xBA368E80

Перед запуском клиента SNTP приложение может дополнительно инициализировать местное время клиента SNTP, которое будет использоваться в качестве базового времени. Для этого оно использует службу *nx_sntp_client_set_local_time*. Она принимает время в формате NTP, секунды и дробную часть, которая обозначает количество миллисекунд в сжатом формате времени NTP. В идеале приложение может получать время SNTP из независимого источника. В клиенте SNTP для NetX Duo отсутствуют API для преобразования года, месяца, даты и времени в формат NTP. Описание формата времени NTP можно найти в стандарте *RFC4330 "Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI"* (RFC4330. Протокол SNMP версии 4 для IPv4, IPv6 и OSI).

Если при запуске клиента SNTP не указано базовое местное время, клиент SNTP при первом обновлении SNTP примет полученное значение без сравнения с местным временем. После этого обновления местного времени будут выполняться с учетом требуемых значений максимального и минимального времени обновления.

Чтобы получить местное время клиента SNTP, приложение может использовать службу *nx_sntp_client_get_local_time_extended*.

### <a name="sntp-sanity-checks"></a>Проверки SNTP 

Клиент проверяет входящий пакет по следующим критериям:

  - Исходный IP-адрес должен соответствовать текущему IP-адресу сервера.

  - Исходный порт отправителя должен соответствовать текущему исходному порту сервера.

  - Длина пакета должна быть не меньше минимально необходимой для хранения сообщения с временем SNTP.

После этого клиент извлекает данные о времени из буфера пакета и применяет к ним следующий набор проверок:

  - Значение 3 для поля Leap Indicator (Индикатор корректировки) означает, что сервер не синхронизирован. Клиент должен попытаться найти другой сервер.

  - Значение 0 для поля Stratum характеризует особый пакет, условно именуемый "поцелуем смерти" (пакет KOD, Kiss of Death). В этой ситуации обработчик KOD в клиенте SMTP вызывает процедуру, определенную пользователем. В нашем примере представлен демонстрационного файл с простым обработчиком KOD для этой ситуации. Поле Reference ID (Идентификатор ссылки) содержит необязательный код, указывающий причину ответа KOD. В любом случае обработчик KOD должен определять способ обработки пакета KOD, полученного от сервера SNTP. Обычно в этом случае выполняется повторная инициализация клиента SNTP с другим сервером SNTP.

  - Версия сервера SNTP, уровень Stratum и режим работы должны соответствовать параметрам службы клиента.

  - Если для клиента настроена максимально допустимая дисперсия серверных часов, клиент проверяет дисперсию серверных часов при получении первого обновления, и если оно превышает максимально допустимое для этого клиента, он отклоняет сервер.

  - Поля с метками времени сервера также проходят определенные проверки. Для одноадресного сервера все поля времени должны быть заполнены и не могут иметь значений NULL. Метка времени Origination (Создание) должна совпадать с меткой времени Transmit (Передача) в запросе времени от клиента SNTP. Это защищает клиента от вредоносных воздействий и нестандартных действий сервера. Широковещательный сервер должен заполнять только метку времени Transmit (Передача). Так как он ничего не получает от клиента, поля Receive (Получение) или Origin (Создание) не могут быть заполнены.

    Если проверка не пройдена, полученное обновление времени считается недопустимым. Служба проверки в клиенте SNTP отслеживает количество последовательно полученных недопустимых обновлений времени от одного сервера.

Когда задача, выполняющая поток клиента SNTP, проверяет допустимость пакета SNTP для изменения местного времени клиента SNTP, она увеличивает значение `nx_sntp_client_invalid_time_updates.` для клиента SNTP. Также она возвращает вызывающему объекту состояние ошибки, но это внутренний процесс, который не будет сразу же заметен для приложения. Чтобы обнаружить проблемы с обновлением времени, нужно запросить значение `nx_sntp_client_invalid_time_updates` для клиента SNTP после получения обновления времени от сервера SNTP.

Если обновление времени пройдет все проверки, клиент попытается преобразовать полученные данные времени в местное время. Если на клиенте настроено вычисление кругового пути, т е. период времени от отправки запроса на обновление до получения ответа, он выполняет такое вычисление. Половина полученного значения добавляется к времени, полученному от сервера.

Затем, если это первое обновление от текущего сервера SNTP, клиент SNTP определяет, следует ли игнорировать разницу между временем сервера и местным временем клиента. После этого для всех обновлений от сервера SNTP оценивается отклонение от местного времени клиента.

Разница между временем клиента и временем сервера сравнивается с `NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT`. Если она превышает это значение, данные отбрасываются. Если разница меньше или равна `NX_SNTP_CLIENT_MIN_TIME_ADJUSTMENT`, различия считаются незначительными и коррекция не применяется.

После выполнения всех этих проверок время обновления будет применено к клиенту SNTP с некоторыми корректировками для учета задержки при внутренней обработке в клиенте SNTP.

### <a name="sntp-asynchronous-unicast-requests"></a>Асинхронные одноадресные запросы SNTP 

Клиент SNTP позволяет ведущему приложению асинхронно отправлять одноадресный запрос на получение текущего времени от сервера NTP.

```C
UINT _nx_sntp_client_request_unicast_time(
NX_SNTP_CLIENT *client_ptr, 
UINT wait_option)
```

Параметр wait (ожидание) означает период времени для ожидания ответа.

Если сервер NTP вернет ответ вовремя, к полученному пакету применяются все процессы обработки и проверки, которые описаны в предыдущем разделе, а затем обновляется местное время клиента SNTP.

Если вызов возвращает сообщение об успешном завершении, приложение может вызвать *nx_sntp_client_utility_display_date_time* или *nx_sntp_client_get_local_time_extended*, чтобы получить обновленное время.

Эти одноадресные запросы не влияют на стандартное расписание работы клиента SNTP, по которому он отправит следующий запрос в одноадресном режиме или будет ожидать сообщение от сервера NTP в широковещательном режиме.

### <a name="periodic-local-time-updates"></a>Периодические обновления местного времени

Максимально допустимая корректировка местного времени задается в миллисекундах в параметре NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT. Интервал обновления для опросов в одноадресном режиме работы клиента SNTP задается в секундах в параметре NX_SNTP_CLIENT_UNICAST_POLL_INTERVAL. Если интервал опроса превышает максимальное допустимую корректировку, будут отклоняться все последующие обновления от сервера после первого обновления. Чтобы избежать этого, клиент SNTP периодически будет обновлять местное время, заданное как NX_SNTP_UPDATE_TIMEOUT_INTERVAL. 

Если возникает расхождение времени между часами реального времени (RTC) на плате и временем сервера (которое должно применяться для изменения местного времени клиента SNTP), часы RTC должны синхронизироваться со временем клиента SNTP (этот процесс не описан в этом руководстве пользователя).

Так как обновления сервера SNTP не могут происходить чаще, чем раз в час, нет никакого смысла опрашивать клиент SNTP на наличие обновлений на сервере чаще этого интервала. Но при этом клиент SNTP должен обновлять свои часы местного времени достаточно часто, чтобы не нарушить ограничения, заданные параметром максимально допустимой корректировки времени NX_SNTP_CLIENT_MAX_TIME_LAPSE.

Кроме того, максимально допустимая корректировка NX_SNTP_CLIENT_MAX_TIME_LAPSE может иметь значение больше, чем период обновления для одноадресного режима (или ожидаемый период широковещательных пакетов). Это устраняет необходимость в использовании независимых часов RTC. Но протокол SNTP предназначен для того, чтобы избежать полной зависимости от локальных часов RTC или сетевых обновлений времени. Кроме того, обновления от сервера SNTP позволяют избежать постепенного отклонения местного времени.

## <a name="multiple-network-interfaces"></a>Использование нескольких сетевых интерфейсов

Клиент SNTP для NetX Duo можно настроить для работы в вторичных сетях, если для них зарегистрирован экземпляр IP-адреса. Дополнительные сведения о регистрации дополнительных сетей см. в руководстве пользователя NetX Duo или NetX.

В вызове *nx_sntp_client_create* установите для третьего входного параметра, iface_index, значение индекса сети, чтобы клиент SNTP получал обновления времени. Первичный интерфейс всегда имеет значение индекса 0. Клиент SNTP для NetX Duo не поддерживает одновременное обновление времени через несколько сетевых интерфейсов.

## <a name="sntp-and-ntp-rfcs"></a>RFC для SNTP и NTP

Клиент SNTP для NetX Duo соответствует требованиям стандарта RFC4330 "Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI" (RFC4330. Протокол SNMP версии 4 для IPv4, IPv6 и OSI) и всех смежных RFC.